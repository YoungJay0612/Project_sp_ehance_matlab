<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T1U3">y</span>,<span class="var type1" id="S3T2U4">out</span>]=omlsa_new_fft(<span class="var type1" id="S4T3U7">Y_BUF</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"><span class="comment">% omlsa : Single Channel OM-LSA with IMCRA noise estimator</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">% ***************************************************************@</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"><span class="comment">% Inputs:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">%    fin,  input file name (fin.wav)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"><span class="comment">%    fout, output file name (fout.wav)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">% Output:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"><span class="comment">%    in,  samples of the input file</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="comment">%    out, samples of the output file</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"><span class="comment">% Usage:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"><span class="comment">%    [in, out]=omlsa(fin,fout);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"><span class="comment">%    omlsa(fin);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">% Defaults:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"><span class="comment">%    fout= [fin,'_omlsa'];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">%</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="comment">% Copyright (c) 2003. Prof Israel Cohen.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="comment">% All rights reserved. </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="comment">% ***************************************************************@</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"><span class="comment">% 1) Parameters of Short Time Fourier Analysis:</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="mxinfo " id="T4:U4"><span class="var type1" id="S5T4U10">Fs_ref</span>=<span class="mxinfo " id="T4:U6">16e3</span></span>;        <span class="comment">% 1.1) Reference Sampling frequency</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="mxinfo " id="T4:U7"><span class="var type1" id="S6T4U14">M_ref</span>=<span class="mxinfo " id="T4:U9">512</span></span>;      <span class="comment">% 1.2) Size of analysis window</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line"><span class="mxinfo " id="T4:U10"><span class="var type1" id="S7T4U18">Mo_ref</span>=<span class="mxinfo " id="T4:U12">0.75*<span class="var type1" id="S6T4U21">M_ref</span></span></span>;  <span class="comment">% 1.3) Number of overlapping samples in consecutive frames</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="comment">% 2) Parameters of Noise Spectrum Estimate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line"><span class="mxinfo " id="T4:U14"><span class="var type1" id="S8T4U24">w</span>=<span class="mxinfo " id="T4:U16">1</span></span>;            <span class="comment">% 2.1)  Size of frequency smoothing window function=2*w+1</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line"><span class="mxinfo " id="T4:U17"><span class="var type1" id="S9T4U28">alpha_s_ref</span>=<span class="mxinfo " id="T4:U19">0.9</span></span>;    <span class="comment">% 2.2)  Recursive averaging parameter for the smoothing operation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="mxinfo " id="T4:U20"><span class="var type1" id="S10T4U32">Nwin</span>=<span class="mxinfo " id="T4:U22">8</span></span>;     <span class="comment">% 2.3)  Resolution of local minima search</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line"><span class="mxinfo " id="T4:U23"><span class="var type1" id="S11T4U36">Vwin</span>=<span class="mxinfo " id="T4:U25">15</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line"><span class="mxinfo " id="T4:U26"><span class="var type1" id="S12T4U40">delta_s</span>=<span class="mxinfo " id="T4:U28">1.67</span></span>;       <span class="comment">% 2.4)  Local minimum factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="mxinfo " id="T4:U29"><span class="var type1" id="S13T4U44">Bmin</span>=<span class="mxinfo " id="T4:U31">1.66</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"><span class="mxinfo " id="T4:U32"><span class="var type1" id="S14T4U48">delta_y</span>=<span class="mxinfo " id="T4:U34">4.6</span></span>;        <span class="comment">% 2.4)  Local minimum factor</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="mxinfo " id="T4:U35"><span class="var type1" id="S15T4U52">delta_yt</span>=<span class="mxinfo " id="T4:U37">3</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line"><span class="mxinfo " id="T4:U38"><span class="var type1" id="S16T4U56">alpha_d_ref</span>=<span class="mxinfo " id="T4:U40">0.85</span></span>;   <span class="comment">% 2.7)  Recursive averaging parameter for the noise</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line"><span class="comment">% 3) Parameters of a Priori Probability for Signal-Absence Estimate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line"><span class="mxinfo " id="T4:U41"><span class="var type1" id="S17T4U60">alpha_xi_ref</span>=<span class="mxinfo " id="T4:U43">0.7</span></span>;   <span class="comment">% 3.1) Recursive averaging parameter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line"><span class="mxinfo " id="T4:U44"><span class="var type1" id="S18T4U64">w_xi_local</span>=<span class="mxinfo " id="T4:U46">1</span></span>;   <span class="comment">% 3.2) Size of frequency local smoothing window function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line"><span class="mxinfo " id="T4:U47"><span class="var type1" id="S19T4U68">w_xi_global</span>=<span class="mxinfo " id="T4:U49">15</span></span>;     <span class="comment">% 3.3) Size of frequency local smoothing window function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line"><span class="mxinfo " id="T4:U50"><span class="var type1" id="S20T4U72">f_u</span>=<span class="mxinfo " id="T4:U52">10e3</span></span>;       <span class="comment">% 3.4) Upper frequency threshold for global decision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line"><span class="mxinfo " id="T4:U53"><span class="var type1" id="S21T4U76">f_l</span>=<span class="mxinfo " id="T4:U55">50</span></span>;         <span class="comment">% 3.5) Lower frequency threshold for global decision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line"><span class="mxinfo " id="T4:U56"><span class="var type1" id="S22T4U80">P_min</span>=<span class="mxinfo " id="T4:U58">0.005</span></span>;        <span class="comment">% 3.6) Lower bound constraint</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line"><span class="mxinfo " id="T4:U59"><span class="var type1" id="S23T4U84">xi_lu_dB</span>=<span class="mxinfo " id="T4:U61">-<span class="mxinfo " id="T4:U62">5</span></span></span>;    <span class="comment">% 3.7) Upper threshold for local decision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line"><span class="mxinfo " id="T4:U63"><span class="var type1" id="S24T4U89">xi_ll_dB</span>=<span class="mxinfo " id="T4:U65">-<span class="mxinfo " id="T4:U66">10</span></span></span>;   <span class="comment">% 3.8) Lower threshold for local decision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line"><span class="mxinfo " id="T4:U67"><span class="var type1" id="S25T4U94">xi_gu_dB</span>=<span class="mxinfo " id="T4:U69">-<span class="mxinfo " id="T4:U70">5</span></span></span>;    <span class="comment">% 3.9) Upper threshold for global decision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line"><span class="mxinfo " id="T4:U71"><span class="var type1" id="S26T4U99">xi_gl_dB</span>=<span class="mxinfo " id="T4:U73">-<span class="mxinfo " id="T4:U74">10</span></span></span>;   <span class="comment">% 3.10) Lower threshold for global decision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line"><span class="mxinfo " id="T4:U75"><span class="var type1" id="S27T4U104">xi_fu_dB</span>=<span class="mxinfo " id="T4:U77">-<span class="mxinfo " id="T4:U78">5</span></span></span>;    <span class="comment">% 3.11) Upper threshold for local decision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line"><span class="mxinfo " id="T4:U79"><span class="var type1" id="S28T4U109">xi_fl_dB</span>=<span class="mxinfo " id="T4:U81">-<span class="mxinfo " id="T4:U82">10</span></span></span>;   <span class="comment">% 3.12) Lower threshold for local decision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line"><span class="mxinfo " id="T4:U83"><span class="var type1" id="S29T4U114">xi_mu_dB</span>=<span class="mxinfo " id="T4:U85">10</span></span>;    <span class="comment">% 3.13) Upper threshold for xi_m</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line"><span class="mxinfo " id="T4:U86"><span class="var type1" id="S30T4U118">xi_ml_dB</span>=<span class="mxinfo " id="T4:U88">0</span></span>;         <span class="comment">% 3.14) Lower threshold for xi_m</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line"><span class="mxinfo " id="T4:U89"><span class="var type1" id="S31T4U122">q_max</span>=<span class="mxinfo " id="T4:U91">0.998</span></span>;        <span class="comment">% 3.15) Upper limit constraint</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line"><span class="comment">% 4) Parameters of "Decision-Directed" a Priori SNR Estimate</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line"><span class="mxinfo " id="T4:U92"><span class="var type1" id="S32T4U126">alpha_eta_ref</span>=<span class="mxinfo " id="T4:U94">0.95</span></span>; <span class="comment">% 4.1) Recursive averaging parameter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line"><span class="mxinfo " id="T4:U95"><span class="var type1" id="S33T4U130">eta_min_dB</span>=<span class="mxinfo " id="T4:U97">-18</span></span>; <span class="comment">% 4.2) Lower limit constraint</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="comment">% 5) Flags</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line"><span class="mxinfo " id="T4:U98"><span class="var type1" id="S34T4U135">broad_flag</span>=<span class="mxinfo " id="T4:U100">1</span></span>;               <span class="comment">% broad band flag   % new version</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="mxinfo " id="T4:U101"><span class="var type1" id="S35T4U139">tone_flag</span>=<span class="mxinfo " id="T4:U103">1</span></span>;                <span class="comment">% pure tone flag   % new version</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"><span class="mxinfo " id="T5:U104"><span class="var type1" id="S36T5U143">nonstat</span>=<span class="mxinfo " id="T5:U106"><span class="string">'medium'</span></span></span>;                <span class="comment">%Non stationarity  % new version</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="comment">% Read input data</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"><span class="mxinfo " id="T4:U107"><span class="var type1" id="S37T4U147">Fs</span> = <span class="mxinfo " id="T4:U109">16000</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="mxinfo " id="T4:U110"><span class="var type1" id="S38T4U151">N</span> = <span class="mxinfo " id="T4:U112">length(<span class="var type1" id="S4T3U154">Y_BUF</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="comment">% Adjust parameters according to the actual sampling frequency</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"><span class="keyword">if</span> <span class="var type1" id="S37T4U158">Fs</span>~=<span class="var type1" id="S5T4U159">Fs_ref</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line">    <span class="var type0" id="S40T0U162">M</span>=2^round(log2(<span class="var type0" id="S37T0U171">Fs</span>/<span class="var type0" id="S5T0U172">Fs_ref</span>*<span class="var type0" id="S6T0U173">M_ref</span>));</span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line">    <span class="var type0" id="S43T0U176">Mo</span>=<span class="var type0" id="S7T0U179">Mo_ref</span>/<span class="var type0" id="S6T0U180">M_ref</span>*<span class="var type0" id="S40T0U181">M</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line">    <span class="var type0" id="S44T0U184">alpha_s</span>=<span class="var type0" id="S9T0U186">alpha_s_ref</span>^(<span class="var type0" id="S6T0U191">M_ref</span>/<span class="var type0" id="S40T0U192">M</span>*<span class="var type0" id="S37T0U193">Fs</span>/<span class="var type0" id="S5T0U194">Fs_ref</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line">    <span class="var type0" id="S45T0U197">alpha_d</span>=<span class="var type0" id="S16T0U199">alpha_d_ref</span>^(<span class="var type0" id="S6T0U204">M_ref</span>/<span class="var type0" id="S40T0U205">M</span>*<span class="var type0" id="S37T0U206">Fs</span>/<span class="var type0" id="S5T0U207">Fs_ref</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">    <span class="var type0" id="S46T0U210">alpha_eta</span>=<span class="var type0" id="S32T0U212">alpha_eta_ref</span>^(<span class="var type0" id="S6T0U217">M_ref</span>/<span class="var type0" id="S40T0U218">M</span>*<span class="var type0" id="S37T0U219">Fs</span>/<span class="var type0" id="S5T0U220">Fs_ref</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">    <span class="var type0" id="S47T0U223">alpha_xi</span>=<span class="var type0" id="S17T0U225">alpha_xi_ref</span>^(<span class="var type0" id="S6T0U230">M_ref</span>/<span class="var type0" id="S40T0U231">M</span>*<span class="var type0" id="S37T0U232">Fs</span>/<span class="var type0" id="S5T0U233">Fs_ref</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">    <span class="mxinfo " id="T4:U116"><span class="var type1" id="S40T4U237">M</span>=<span class="var type1" id="S6T4U238">M_ref</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">    <span class="mxinfo " id="T4:U119"><span class="var type1" id="S43T4U241">Mo</span>=<span class="var type1" id="S7T4U242">Mo_ref</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">    <span class="mxinfo " id="T4:U122"><span class="var type1" id="S44T4U245">alpha_s</span>=<span class="var type1" id="S9T4U246">alpha_s_ref</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">    <span class="mxinfo " id="T4:U125"><span class="var type1" id="S45T4U249">alpha_d</span>=<span class="var type1" id="S16T4U250">alpha_d_ref</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">    <span class="mxinfo " id="T4:U128"><span class="var type1" id="S46T4U253">alpha_eta</span>=<span class="var type1" id="S32T4U254">alpha_eta_ref</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">    <span class="mxinfo " id="T4:U131"><span class="var type1" id="S47T4U257">alpha_xi</span>=<span class="var type1" id="S17T4U258">alpha_xi_ref</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line"><span class="mxinfo " id="T4:U134"><span class="var type1" id="S48T4U261">alpha_d_long</span>=<span class="mxinfo " id="T4:U136">0.99</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line"><span class="mxinfo " id="T4:U137"><span class="var type1" id="S49T4U265">eta_min</span>=<span class="mxinfo " id="T4:U139">10^(<span class="var type1" id="S33T4U270">eta_min_dB</span>/10)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line"><span class="mxinfo " id="T4:U141"><span class="var type1" id="S50T4U274">G_f</span>=<span class="mxinfo " id="T4:U143"><span class="var type1" id="S49T4U276">eta_min</span>^0.5</span></span>;       <span class="comment">% Gain floor</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line"><span class="comment">% window function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line"><span class="mxinfo " id="T2:U145"><span class="var type1" id="S51T2U280">win</span>=<span class="mxinfo " id="T2:U147">hamming(<span class="var type1" id="S40T4U283">M</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line"><span class="comment">% find a normalization factor for the window</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line"><span class="mxinfo " id="T2:U149"><span class="var type1" id="S53T2U286">win2</span>=<span class="mxinfo " id="T2:U151"><span class="var type1" id="S51T2U288">win</span>.^2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line"><span class="mxinfo " id="T4:U153"><span class="var type1" id="S54T4U292">Mno</span>=<span class="mxinfo " id="T4:U155"><span class="var type1" id="S40T4U294">M</span>-<span class="var type1" id="S43T4U295">Mo</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line"><span class="mxinfo " id="T6:U158"><span class="var type1" id="S55T6U298">W0</span>=<span class="mxinfo " id="T6:U160"><span class="var type1" id="S53T2U300">win2</span>(<span class="mxinfo " id="T7:U162"><span class="mxinfo " id="T4:U163">1</span>:<span class="var type1" id="S54T4U303">Mno</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S56T4U306">k</span>=<span class="var type1" id="S54T4U309">Mno</span>:<span class="var type1" id="S54T4U310">Mno</span>:<span class="var type1" id="S40T4U312">M</span>-1</span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">    <span class="mxinfo " id="T8:U169"><span class="var type1" id="S57T8U316">swin2</span>=<span class="mxinfo " id="T8:U171"><span class="fcn" id="F75N5:B318">lnshift</span>(<span class="var type1" id="S53T2U319">win2</span>,<span class="var type1" id="S56T4U320">k</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">    <span class="mxinfo " id="T6:U174"><span class="var type1" id="S55T6U323">W0</span>=<span class="mxinfo " id="T6:U176"><span class="var type1" id="S55T6U325">W0</span>+<span class="mxinfo " id="T6:U178"><span class="var type1" id="S57T8U327">swin2</span>(<span class="mxinfo " id="T7:U180"><span class="mxinfo " id="T4:U181">1</span>:<span class="var type1" id="S54T4U330">Mno</span></span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line"><span class="mxinfo " id="T4:U183"><span class="var type1" id="S55T4U333">W0</span>=<span class="mxinfo " id="T4:U185"><span class="mxinfo " id="T4:U186">mean(<span class="var type1" id="S55T6U337">W0</span>)</span>^0.5</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line"><span class="mxinfo " id="T2:U188"><span class="var type1" id="S51T2U341">win</span>=<span class="mxinfo " id="T2:U190"><span class="var type1" id="S51T2U343">win</span>/<span class="var type1" id="S55T4U344">W0</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line"><span class="mxinfo " id="T4:U193"><span class="var type1" id="S60T4U347">Cwin</span>=<span class="mxinfo " id="T4:U195"><span class="mxinfo " id="T4:U196">sum(<span class="mxinfo " id="T2:U197"><span class="var type1" id="S51T2U352">win</span>.^2</span>)</span>^0.5</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line"><span class="comment">%win=win/Cwin;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line"><span class="mxinfo " id="T4:U199"><span class="var type1" id="S62T4U357">Nframes</span>=<span class="mxinfo " id="T4:U201">fix((<span class="var type1" id="S38T4U363">N</span>-<span class="var type1" id="S43T4U364">Mo</span>)/<span class="var type1" id="S54T4U365">Mno</span>)</span></span>;   <span class="comment">%  number of frames</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line"><span class="mxinfo " id="T2:U205"><span class="var type1" id="S3T2U368">out</span>=<span class="mxinfo " id="T2:U207">zeros(<span class="var type1" id="S40T4U371">M</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line"><span class="mxinfo " id="T9:U209"><span class="var type1" id="S65T9U375">b</span>=<span class="mxinfo " id="T9:U211">hanning(2*<span class="var type1" id="S8T4U381">w</span>+1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line"><span class="mxinfo " id="T9:U213"><span class="var type1" id="S65T9U385">b</span>=<span class="mxinfo " id="T9:U215"><span class="var type1" id="S65T9U387">b</span>/sum(<span class="var type1" id="S65T9U390">b</span>)</span></span>;     <span class="comment">% normalize the window function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line"><span class="mxinfo " id="T9:U218"><span class="var type1" id="S67T9U393">b_xi_local</span>=<span class="mxinfo " id="T9:U220">hanning(2*<span class="var type1" id="S18T4U399">w_xi_local</span>+1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line"><span class="mxinfo " id="T9:U222"><span class="var type1" id="S67T9U403">b_xi_local</span>=<span class="mxinfo " id="T9:U224"><span class="var type1" id="S67T9U405">b_xi_local</span>/sum(<span class="var type1" id="S67T9U408">b_xi_local</span>)</span></span>;  <span class="comment">% normalize the window function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line"><span class="mxinfo " id="T10:U227"><span class="var type1" id="S68T10U411">b_xi_global</span>=<span class="mxinfo " id="T10:U229">hanning(2*<span class="var type1" id="S19T4U417">w_xi_global</span>+1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line"><span class="mxinfo " id="T10:U231"><span class="var type1" id="S68T10U421">b_xi_global</span>=<span class="mxinfo " id="T10:U233"><span class="var type1" id="S68T10U423">b_xi_global</span>/sum(<span class="var type1" id="S68T10U426">b_xi_global</span>)</span></span>;   <span class="comment">% normalize the window function</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="mxinfo " id="T4:U236"><span class="var type1" id="S69T4U429">l_mod_lswitch</span>=<span class="mxinfo " id="T4:U238">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"><span class="mxinfo " id="T4:U239"><span class="var type1" id="S70T4U433">M21</span>=<span class="mxinfo " id="T4:U241"><span class="var type1" id="S40T4U436">M</span>/2+1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="mxinfo " id="T4:U243"><span class="var type1" id="S71T4U441">k_u</span>=<span class="mxinfo " id="T4:U245">round(<span class="var type1" id="S20T4U447">f_u</span>/<span class="var type1" id="S37T4U448">Fs</span>*<span class="var type1" id="S40T4U449">M</span>+1)</span></span>;  <span class="comment">% Upper frequency bin for global decision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"><span class="mxinfo " id="T4:U249"><span class="var type1" id="S72T4U453">k_l</span>=<span class="mxinfo " id="T4:U251">round(<span class="mxinfo " id="T4:U252"><span class="var type1" id="S21T4U459">f_l</span>/<span class="var type1" id="S37T4U460">Fs</span>*<span class="var type1" id="S40T4U461">M</span>+1</span>)</span></span>;  <span class="comment">% Lower frequency bin for global decision</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="mxinfo " id="T4:U256"><span class="var type1" id="S71T4U465">k_u</span>=<span class="mxinfo " id="T4:U258">min(<span class="var type1" id="S71T4U468">k_u</span>,<span class="var type1" id="S70T4U469">M21</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"><span class="mxinfo " id="T4:U261"><span class="var type1" id="S74T4U472">k2_local</span>=<span class="mxinfo " id="T4:U263">round(<span class="mxinfo " id="T4:U264">500/<span class="var type1" id="S37T4U479">Fs</span>*<span class="var type1" id="S40T4U480">M</span>+1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"><span class="mxinfo " id="T4:U267"><span class="var type1" id="S75T4U484">k3_local</span>=<span class="mxinfo " id="T4:U269">round(<span class="mxinfo " id="T4:U270">3500/<span class="var type1" id="S37T4U491">Fs</span>*<span class="var type1" id="S40T4U492">M</span>+1</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"><span class="mxinfo " id="T4:U273"><span class="var type1" id="S76T4U496">eta_2term</span>=<span class="mxinfo " id="T4:U275">1</span></span>; <span class="mxinfo " id="T4:U276"><span class="var type1" id="S77T4U500">xi</span>=<span class="mxinfo " id="T4:U278">0</span></span>; <span class="mxinfo " id="T4:U279"><span class="var type1" id="S78T4U504">xi_frame</span>=<span class="mxinfo " id="T4:U281">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"><span class="mxinfo " id="T4:U282"><span class="var type1" id="S79T4U508">Ncount</span>=<span class="mxinfo " id="T4:U284">round(<span class="mxinfo " id="T4:U285"><span class="var type1" id="S62T4U512">Nframes</span>/10</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line"><span class="mxinfo " id="T4:U287"><span class="var type1" id="S80T4U516">l_fnz</span>=<span class="mxinfo " id="T4:U289">1</span></span>;      <span class="comment">% counter for the first frame which is non-zero    % new version omlsa3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line"><span class="mxinfo " id="T4:U290"><span class="var type1" id="S81T4U520">fnz_flag</span>=<span class="mxinfo " id="T4:U292">0</span></span>;     <span class="comment">% flag for the first frame which is non-zero    % new version omlsa3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"><span class="mxinfo " id="T4:U293"><span class="var type1" id="S82T4U524">zero_thres</span>=<span class="mxinfo " id="T4:U295">1e-10</span></span>;      <span class="comment">% new version omlsa3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,124" id="srcline124">124</a></span><span class="line"><span class="comment">% zero_thres is a threshold for discriminating between zero and nonzero sample.</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,125" id="srcline125">125</a></span><span class="line"><span class="comment">% You may choose zero_thres=0, but then the program  handles samples which are identically zero (and not “epsilon” values).</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,126" id="srcline126">126</a></span><span class="line"> <span class="mxinfo " id="T4:U296"><span class="var type1" id="S37T4U528">Fs</span> = <span class="mxinfo " id="T4:U298">16000</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,127" id="srcline127">127</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,128" id="srcline128">128</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,129" id="srcline129">129</a></span><span class="line"><span class="mxinfo " id="T4:U299"><span class="var type1" id="S83T4U532">InitFrame</span> = <span class="mxinfo " id="T4:U301">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,130" id="srcline130">130</a></span><span class="line"><span class="mxinfo " id="T4:U302"><span class="var type1" id="S84T4U536">EndFrame</span> = <span class="var type1" id="S40T4U537">M</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,131" id="srcline131">131</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,132" id="srcline132">132</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S85T4U540">l</span>=<span class="mxinfo " id="T4:U306">1</span>:<span class="var type1" id="S62T4U543">Nframes</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,133" id="srcline133">133</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,134" id="srcline134">134</a></span><span class="line">        <span class="mxinfo " id="T1:U308"><span class="var type1" id="S2T1U546">y</span> = <span class="mxinfo " id="T1:U310"><span class="var type1" id="S4T3U548">Y_BUF</span>(<span class="mxinfo " id="T11:U312"><span class="var type1" id="S83T4U550">InitFrame</span>:<span class="var type1" id="S84T4U551">EndFrame</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,135" id="srcline135">135</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,136" id="srcline136">136</a></span><span class="line">    <span class="keyword">if</span> (<span class="mxinfo " id="T12:U315">~<span class="var type1" id="S81T4U558">fnz_flag</span></span> &amp;&amp; <span class="mxinfo " id="T12:U317"><span class="mxinfo " id="T4:U318">abs(<span class="mxinfo " id="T4:U319"><span class="var type1" id="S2T1U563">y</span>(<span class="mxinfo " id="T4:U321">1</span>)</span>)</span>&gt;<span class="var type1" id="S82T4U565">zero_thres</span></span>) ||  (<span class="var type1" id="S81T4U568">fnz_flag</span> &amp;&amp; <span class="mxinfo " id="T12:U324">any(<span class="mxinfo " id="T13:U325"><span class="mxinfo " id="T14:U326">abs(<span class="var type1" id="S2T1U574">y</span>)</span>&gt;<span class="var type1" id="S82T4U575">zero_thres</span></span>)</span>)       <span class="comment">% new version omlsa3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,137" id="srcline137">137</a></span><span class="line">        <span class="mxinfo " id="T4:U329"><span class="var type1" id="S81T4U578">fnz_flag</span>=<span class="mxinfo " id="T4:U331">1</span></span>;     <span class="comment">% new version omlsa3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,138" id="srcline138">138</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,139" id="srcline139">139</a></span><span class="line">        <span class="comment">% 1. Short Time Fourier Analysis</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,140" id="srcline140">140</a></span><span class="line">        <span class="mxinfo " id="T15:U332"><span class="var type1" id="S88T15U582">Y</span>=<span class="mxinfo " id="T15:U334">fft(<span class="mxinfo " id="T2:U335"><span class="var type1" id="S51T2U586">win</span>.*<span class="var type1" id="S2T1U587">y</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,141" id="srcline141">141</a></span><span class="line">        <span class="mxinfo " id="T16:U338"><span class="var type1" id="S90T16U590">Ya2</span>=<span class="mxinfo " id="T16:U340"><span class="mxinfo " id="T16:U341">abs(<span class="mxinfo " id="T17:U342"><span class="var type1" id="S88T15U595">Y</span>(1:<span class="var type1" id="S70T4U598">M21</span>)</span>)</span>.^2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,142" id="srcline142">142</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,143" id="srcline143">143</a></span><span class="line">          <span class="mxinfo " id="T2:U345"><span class="var type1" id="S91T2U602">x</span>= <span class="mxinfo " id="T2:U347">real(<span class="mxinfo " id="T15:U348">ifft(<span class="var type1" id="S88T15U607">Y</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,144" id="srcline144">144</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,145" id="srcline145">145</a></span><span class="line">         <span class="mxinfo " id="T2:U350"><span class="var type1" id="S91T2U610">x</span> = <span class="mxinfo " id="T2:U352"><span class="var type1" id="S51T2U612">win</span>.*<span class="var type1" id="S91T2U613">x</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,146" id="srcline146">146</a></span><span class="line">        <span class="mxinfo " id="T2:U355"><span class="var type1" id="S3T2U616">out</span>=<span class="mxinfo " id="T2:U357"><span class="var type1" id="S3T2U618">out</span>+<span class="var type1" id="S91T2U619">x</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,147" id="srcline147">147</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,148" id="srcline148">148</a></span><span class="line">      </span></span>
<span class="srcline"><span class="lineno"><a href="1,149" id="srcline149">149</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,150" id="srcline150">150</a></span><span class="line">    <span class="keyword">else</span>        <span class="comment">% new version omlsa3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,151" id="srcline151">151</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T12:U360">~<span class="var type1" id="S81T4U624">fnz_flag</span></span>        <span class="comment">% new version omlsa3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,152" id="srcline152">152</a></span><span class="line">            <span class="mxinfo " id="T4:U362"><span class="var type1" id="S80T4U627">l_fnz</span>=<span class="mxinfo " id="T4:U364"><span class="var type1" id="S80T4U629">l_fnz</span>+<span class="mxinfo " id="T4:U366">1</span></span></span>;        <span class="comment">% new version omlsa3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,153" id="srcline153">153</a></span><span class="line">        <span class="keyword">end</span>         <span class="comment">% new version omlsa3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,154" id="srcline154">154</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,155" id="srcline155">155</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,156" id="srcline156">156</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,157" id="srcline157">157</a></span><span class="line">    <span class="mxinfo " id="T2:U367"><span class="var type1" id="S3T2U633">out</span>=<span class="mxinfo " id="T2:U369">[<span class="mxinfo " id="T18:U370"><span class="var type1" id="S3T2U637">out</span>(<span class="mxinfo " id="T19:U372"><span class="mxinfo " id="T4:U373"><span class="var type1" id="S54T4U640">Mno</span>+1</span>:<span class="var type1" id="S40T4U642">M</span></span>)</span>; <span class="mxinfo " id="T6:U376">zeros(<span class="var type1" id="S54T4U646">Mno</span>,1)</span>]</span></span>;   <span class="comment">% update output frame</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,158" id="srcline158">158</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,159" id="srcline159">159</a></span><span class="line">    <span class="mxinfo " id="T4:U378"><span class="var type1" id="S83T4U650">InitFrame</span> = <span class="mxinfo " id="T4:U380"><span class="var type1" id="S83T4U652">InitFrame</span> + <span class="var type1" id="S54T4U653">Mno</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,160" id="srcline160">160</a></span><span class="line">    <span class="mxinfo " id="T4:U383"><span class="var type1" id="S84T4U656">EndFrame</span>  = <span class="mxinfo " id="T4:U385"><span class="var type1" id="S84T4U658">EndFrame</span>  + <span class="var type1" id="S54T4U659">Mno</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,161" id="srcline161">161</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,162" id="srcline162">162</a></span><span class="line"><span class="keyword"><span class="keyword">end</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,163" id="srcline163">163</a></span><span class="line"> </span></span>
<span class="srcline"><span class="lineno"><a href="1,164" id="srcline164">164</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,165" id="srcline165">165</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,166" id="srcline166">166</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,167" id="srcline167">167</a></span><span class="line"></span></span>
</pre>
